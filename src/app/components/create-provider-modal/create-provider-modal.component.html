<ion-header class="ion-no-border">
    <ion-toolbar color="primary">
        <ion-title>Nuevo Proveedor de Servicios</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="dismiss()">
                <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
    <form [formGroup]="providerForm" (ngSubmit)="onSubmit()">

        <!-- Nombre del Proveedor -->
        <ion-item lines="none" class="input-item">
            <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
            <ion-input type="text" formControlName="nombre" placeholder="Nombre del proveedor" [clearInput]="true">
            </ion-input>
        </ion-item>
        <div class="error-message" *ngIf="isFieldInvalid('nombre')">
            <ion-text color="danger">
                <small>El nombre es requerido (m√≠nimo 3 caracteres)</small>
            </ion-text>
        </div>

        <!-- Tipo de Servicio -->
        <ion-item lines="none" class="input-item">
            <ion-icon name="apps-outline" slot="start" color="primary"></ion-icon>
            <ion-label position="stacked">Tipo de Servicio *</ion-label>
            <ion-select formControlName="tipo" placeholder="Seleccione el tipo">
                <ion-select-option value="Agua">üíß Agua</ion-select-option>
                <ion-select-option value="Electricidad">‚ö° Electricidad</ion-select-option>
                <ion-select-option value="Telefon√≠a">üì± Telefon√≠a</ion-select-option>
                <ion-select-option value="Internet">üåê Internet</ion-select-option>
                <ion-select-option value="Cable">üì∫ Cable</ion-select-option>
                <ion-select-option value="Seguro">üõ°Ô∏è Seguro</ion-select-option>
                <ion-select-option value="Municipalidades">üèõÔ∏è Municipalidades</ion-select-option>
                <ion-select-option value="Cobro Judicial">‚öñÔ∏è Cobro Judicial</ion-select-option>
                <ion-select-option value="Otros">üìã Otros</ion-select-option>
            </ion-select>
        </ion-item>
        <div class="error-message" *ngIf="isFieldInvalid('tipo')">
            <ion-text color="danger">
                <small>Seleccione un tipo de servicio</small>
            </ion-text>
        </div>

        <!-- Icono (opcional) -->
        <ion-item lines="none" class="input-item">
            <ion-icon name="images-outline" slot="start" color="primary"></ion-icon>
            <ion-input type="text" formControlName="icon" placeholder="Icono (ej: water-outline)" [clearInput]="true">
            </ion-input>
        </ion-item>
        <div class="info-message">
            <ion-text color="medium">
                <small>Nombre del icono de Ionicons (opcional)</small>
            </ion-text>
        </div>

        <!-- Reglas de Validaci√≥n -->
        <ion-card class="validation-card">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="shield-checkmark-outline"></ion-icon>
                    Reglas de Validaci√≥n
                </ion-card-title>
            </ion-card-header>
            <ion-card-content>

                <!-- Tipo de Validaci√≥n -->
                <ion-item lines="none">
                    <ion-label position="stacked">Tipo de Validaci√≥n *</ion-label>
                    <ion-select formControlName="tipoValidacion" (ionChange)="onValidationTypeChange()">
                        <ion-select-option value="rango">Rango de d√≠gitos (ej: 8-12)</ion-select-option>
                        <ion-select-option value="exacto">Cantidad exacta (ej: 10)</ion-select-option>
                        <ion-select-option value="minimo">M√≠nimo de d√≠gitos (ej: m√≠n 8)</ion-select-option>
                        <ion-select-option value="custom">Patr√≥n personalizado (regex)</ion-select-option>
                    </ion-select>
                </ion-item>

                <!-- Rango de D√≠gitos -->
                <div *ngIf="providerForm.get('tipoValidacion')?.value === 'rango'">
                    <ion-row>
                        <ion-col size="6">
                            <ion-item lines="none">
                                <ion-label position="stacked">M√≠nimo</ion-label>
                                <ion-input type="number" formControlName="digitosMin" placeholder="8" min="1">
                                </ion-input>
                            </ion-item>
                        </ion-col>
                        <ion-col size="6">
                            <ion-item lines="none">
                                <ion-label position="stacked">M√°ximo</ion-label>
                                <ion-input type="number" formControlName="digitosMax" placeholder="12" min="1">
                                </ion-input>
                            </ion-item>
                        </ion-col>
                    </ion-row>
                </div>

                <!-- Cantidad Exacta -->
                <ion-item lines="none" *ngIf="providerForm.get('tipoValidacion')?.value === 'exacto'">
                    <ion-label position="stacked">Cantidad de d√≠gitos</ion-label>
                    <ion-input type="number" formControlName="digitosExactos" placeholder="10" min="1">
                    </ion-input>
                </ion-item>

                <!-- M√≠nimo de D√≠gitos -->
                <ion-item lines="none" *ngIf="providerForm.get('tipoValidacion')?.value === 'minimo'">
                    <ion-label position="stacked">M√≠nimo de d√≠gitos</ion-label>
                    <ion-input type="number" formControlName="digitosMin" placeholder="8" min="1">
                    </ion-input>
                </ion-item>

                <!-- Patr√≥n Personalizado -->
                <ion-item lines="none" *ngIf="providerForm.get('tipoValidacion')?.value === 'custom'">
                    <ion-label position="stacked">Expresi√≥n Regular (regex)</ion-label>
                    <ion-input type="text" formControlName="regexCustom" placeholder="^\d{8,12}$">
                    </ion-input>
                </ion-item>

                <!-- Vista Previa de Validaci√≥n -->
                <div class="preview-section" *ngIf="previewValidation">
                    <ion-text color="medium">
                        <p><strong>Vista Previa:</strong></p>
                        <p>{{ previewValidation }}</p>
                    </ion-text>
                </div>

                <!-- Probar Validaci√≥n -->
                <ion-item lines="none" class="test-input">
                    <ion-label position="stacked">Probar n√∫mero de contrato</ion-label>
                    <ion-input type="text" [(ngModel)]="testContract" [ngModelOptions]="{standalone: true}"
                        placeholder="Ingrese un n√∫mero para probar" (ionInput)="testValidation()">
                    </ion-input>
                    <ion-icon slot="end"
                        [name]="testResult === null ? 'help-circle-outline' : testResult ? 'checkmark-circle' : 'close-circle'"
                        [color]="testResult === null ? 'medium' : testResult ? 'success' : 'danger'" size="large">
                    </ion-icon>
                </ion-item>
                <div class="test-result" *ngIf="testResult !== null">
                    <ion-text [color]="testResult ? 'success' : 'danger'">
                        <small>
                            <ion-icon [name]="testResult ? 'checkmark-circle' : 'close-circle'"></ion-icon>
                            {{ testResult ? 'V√°lido' : 'No v√°lido' }}
                        </small>
                    </ion-text>
                </div>

            </ion-card-content>
        </ion-card>

        <!-- Estado Activo -->
        <ion-item lines="none" class="input-item">
            <ion-icon name="power-outline" slot="start" color="primary"></ion-icon>
            <ion-label>Proveedor Activo</ion-label>
            <ion-toggle formControlName="activo" slot="end" [checked]="true"></ion-toggle>
        </ion-item>

        <!-- Botones -->
        <div class="button-group">
            <ion-button expand="block" type="submit" color="success" [disabled]="providerForm.invalid || isLoading">
                <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
                <span *ngIf="!isLoading">
                    <ion-icon name="add-circle" slot="start"></ion-icon>
                    Crear Proveedor
                </span>
            </ion-button>

            <ion-button expand="block" fill="outline" color="medium" type="button" (click)="dismiss()">
                Cancelar
            </ion-button>
        </div>

    </form>
</ion-content>