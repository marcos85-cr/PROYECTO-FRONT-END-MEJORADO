<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Operaciones de Alto Valor</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openFilterModal()">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Segment de Estado -->
  <ion-toolbar color="secondary">
    <ion-segment [(ngModel)]="selectedStatus" (ionChange)="filterOperations()">
      <ion-segment-button value="all">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
      <ion-segment-button value="Pendiente">
        <ion-label>Pendientes</ion-label>
        <ion-badge color="warning" *ngIf="pendingCount > 0">{{ pendingCount }}</ion-badge>
      </ion-segment-button>
      <ion-segment-button value="Bloqueada">
        <ion-label>Bloqueadas</ion-label>
        <ion-badge color="danger" *ngIf="blockedCount > 0">{{ blockedCount }}</ion-badge>
      </ion-segment-button>
      <ion-segment-button value="Aprobada">
        <ion-label>Aprobadas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content color="secondary">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Resumen Rápido -->
  <div class="summary-section" *ngIf="selectedStatus === 'all'">
    <ion-card>
      <ion-card-content>
        <div class="summary-grid">
          <div class="summary-item">
            <ion-icon name="alert-circle" color="danger"></ion-icon>
            <div class="summary-info">
              <h3>{{ criticalCount }}</h3>
              <p>Críticas</p>
            </div>
          </div>
          <div class="summary-item">
            <ion-icon name="warning" color="warning"></ion-icon>
            <div class="summary-info">
              <h3>{{ highRiskCount }}</h3>
              <p>Alto Riesgo</p>
            </div>
          </div>
          <div class="summary-item">
            <ion-icon name="hourglass" color="tertiary"></ion-icon>
            <div class="summary-info">
              <h3>{{ pendingCount }}</h3>
              <p>Pendientes</p>
            </div>
          </div>
          <div class="summary-item">
            <ion-icon name="cash" color="success"></ion-icon>
            <div class="summary-info">
              <h3>{{ totalVolumeFormatted }}</h3>
              <p>Volumen</p>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Operaciones Críticas Destacadas -->
  <div class="critical-alerts" *ngIf="criticalOperations.length > 0">
    <ion-card class="critical-card">
      <ion-card-header>
        <ion-icon name="alert-circle" color="warning"></ion-icon>
        <ion-card-title color="white">Operaciones Críticas</ion-card-title>
        <ion-card-subtitle>Requieren atención inmediata</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let op of criticalOperations" 
            lines="full" 
            button
            (click)="openOperationDetail(op)">
            <ion-label>
              <h3>{{ op.clienteNombre }}</h3>
              <p class="op-tipo">{{ op.tipo }}</p>
              <p class="amount">{{ op.moneda }} {{ op.monto | number:'1.2-2' }}</p>
            </ion-label>
            <ion-icon slot="end" name="chevron-forward" color="white"></ion-icon>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Lista de Operaciones -->
  <div class="operations-container">
    <ion-list *ngIf="filteredOperations.length > 0">
      <ion-item-group *ngFor="let group of groupedOperations">
        <ion-item-divider sticky>
          <ion-label>{{ group.date | date:'fullDate' }}</ion-label>
        </ion-item-divider>

        <ion-item-sliding *ngFor="let operation of group.operations">
          <ion-item lines="full" 
            button 
            (click)="openOperationDetail(operation)"
            [class.high-risk]="operation.nivelRiesgo === 'Crítico'">
            
            <ion-icon slot="start" 
              [name]="getOperationIcon(operation.tipo)"
              [color]="getRiskColor(operation.nivelRiesgo)" 
              size="large"></ion-icon>
            
            <ion-label>
              <h2>{{ operation.clienteNombre }}</h2>
              <p class="operation-type">{{ operation.tipo }}</p>
              <p class="operation-description">{{ operation.descripcion }}</p>
              <div class="operation-meta">
                <ion-badge [color]="getStatusColor(operation.estado)">
                  {{ operation.estado }}
                </ion-badge>
                <ion-badge [color]="getRiskColor(operation.nivelRiesgo)">
                  {{ operation.nivelRiesgo }}
                </ion-badge>
                <span class="operation-time">{{ operation.creadoEn | date:'shortTime' }}</span>
              </div>
            </ion-label>
            
            <div slot="end" class="operation-amount">
              <p class="amount">{{ operation.moneda }} {{ operation.monto | number:'1.2-2' }}</p>
            </div>
          </ion-item>

          <ion-item-options side="start" *ngIf="operation.estado === 'Pendiente'">
            <ion-item-option color="success" (click)="quickApprove(operation)">
              <ion-icon slot="icon-only" name="checkmark"></ion-icon>
            </ion-item-option>
            <ion-item-option color="danger" (click)="quickReject(operation)">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-item-option>
          </ion-item-options>

          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="openOperationDetail(operation)">
              <ion-icon slot="icon-only" name="eye"></ion-icon>
            </ion-item-option>
            <ion-item-option color="warning" (click)="blockOperation(operation)">
              <ion-icon slot="icon-only" name="lock-closed"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-item-group>
    </ion-list>

    <!-- Sin Resultados -->
    <div class="empty-state" *ngIf="filteredOperations.length === 0 && !isLoading">
      <ion-icon name="swap-horizontal-outline" color="medium"></ion-icon>
      <p>No se encontraron operaciones</p>
      <ion-text color="medium">
        <small>{{ getEmptyMessage() }}</small>
      </ion-text>
    </div>

    <!-- Loading -->
    <div class="loading-state" *ngIf="isLoading">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando operaciones...</p>
    </div>
  </div>
</ion-content>